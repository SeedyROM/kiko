#!/bin/bash

# Kill background processes on script exit
trap 'kill $(jobs -p)' EXIT

# ANSI color codes
CLIENT_COLOR='\033[0;94m'    # Light blue
SERVER_COLOR='\033[0;93m'  # Light yellow
NC='\033[0m' # No Color

# Check if Rust is installed
if ! command -v rustc &> /dev/null
then
    echo "‚ùå Rust is not installed. Please install Rust to run this script."
    exit 1
fi

# Check if Trunk is installed
if ! command -v trunk &> /dev/null
then
    echo "‚ùå Trunk is not installed. Please install Trunk to run this script."
    exit 1
fi

# Check if Cargo Watch is installed
if ! command -v cargo-watch &> /dev/null
then
    echo "‚ùå Cargo Watch is not installed. Please install Cargo Watch to run this script."
    exit 1
fi

# Print logo
cat << EOF

,--. ,--.,--.,--.          
|  .'   /\`--'|  |,-. ,---. 
|  .   ' ,--.|     /| .-. |
|  |\   \|  ||  \  \' '-' '
\`--' '--'\`--'\`--'\`--'\`---' 

EOF

echo "üöÄ Starting Kiko development servers..."

# Start backend with colored prefix
echo "üì° Starting backend server..."
cd crates/kiko-backend
cargo watch -w src -x run 2>&1 | awk -v prefix="${SERVER_COLOR}[server]${NC}" '{print prefix " " $0; fflush()}' &
BACKEND_PID=$!

# Wait a moment for backend to start
sleep 2

# Start frontend with colored prefix
echo "üé® Starting frontend server..."
cd ../kiko-frontend
trunk serve 2>&1 | awk -v prefix="${CLIENT_COLOR}[client]${NC}" '{print prefix " " $0; fflush()}' &
FRONTEND_PID=$!

echo "‚úÖ Servers running:"
echo "   Backend:  http://localhost:3030"
echo "   Frontend: http://localhost:8080"
echo ""
echo "Press Ctrl+C to stop both servers"

# Wait for user interrupt
wait